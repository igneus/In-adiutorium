RUBY_COMMAND = 'ruby1.9.1'

def genzalm(zalm, options="", adresar='generovane/')
  wd = Dir.pwd
  syrovy = wd+"/zalmy/"+zalm
  peceny = adresar+zalm.gsub(/\.zalm/, '')+'.tex'
  preprocessor = wd+"/../nastroje/psalmpreprocessor.rb"
  file peceny => [syrovy, preprocessor] do
    chdir adresar
    sh "#{RUBY_COMMAND} #{preprocessor} #{options} #{syrovy}"
    chdir wd
    sh "vlna #{peceny}"
  end
  return peceny
end

def test_lilypondbook_version
  v = `lilypond-book --version`
  if v !~ /^2\.14/ then
    STDERR.puts
    STDERR.puts "!!! Expect problems. Compilation of notated parts of the antiphonal works well only with lilypond-book 2.14.x !!!"
    STDERR.puts
  end
end

##############
# Antifonar: kompletar

adresar_kompletar = 'generovane/kompletar/'

kompletar_options = "--columns --lettrine --dashes --no-paragraph"

file "vystup/antifonar_kompletar.pdf" => ["vystup/antifonar_kompletar.tex", "spolecne.tex"] do
  chdir "vystup"
  sh "pdflatex antifonar_kompletar"
  chdir ".."
end

cislazalmu_kompletar = [4, 134, 91, 86, 143, 31, 130, 16, 88]
zalmy_kompletar = []
cislazalmu_kompletar.each do |i|
  zalmy_kompletar << genzalm("zalm#{i}.zalm", kompletar_options+" --last-accent-only", adresar_kompletar)
end

zalmy_kompletar << genzalm("kantikum_nuncdimittis.zalm", kompletar_options, adresar_kompletar)

# doxologie s jednim akcentem na polovers
zalmy_kompletar << genzalm("doxologie.zalm", "--last-accent-only --no-title", adresar_kompletar)
# doxologie se dvema akcenty na polovers
file adresar_kompletar+"doxologie_2akcenty.tex" => ['zalmy/doxologie.zalm'] do
  chdir adresar_kompletar
  sh "ruby ../../../nastroje/psalmpreprocessor.rb --no-title --output doxologie_2akcenty.tex ../../zalmy/doxologie.zalm"
  chdir "../.."
end
zalmy_kompletar << adresar_kompletar+'doxologie_2akcenty.tex'

file "vystup/antifonar_kompletar.tex" => (["antifonar_kompletar.lytex", adresar_kompletar+"kompletar_1.ly"]+zalmy_kompletar) do
  test_lilypondbook_version
  sh "lilypond-book --output=vystup --pdf antifonar_kompletar.lytex"
end

file (adresar_kompletar+"kompletar_1.ly") => ["../kompletar.ly"] do
  chdir adresar_kompletar
  sh "ruby ../../../nastroje/splitscores.rb --prepend-text '\\include \"spolecne_antifonar.ly\"' --remove-headers ../../../kompletar.ly"
  chdir '../..'
end

task :kompletar => ["vystup/antifonar_kompletar.pdf"]

task :default => [:kompletar]

#######################
# zaltar

zalmyzaltare = []

adresar_zaltar = 'generovane/zaltar/'

cislazalmu_zaltar = %w( 95 100 67 24

                  141 142 63 149 118i 118ii 118iii 110 114
                  5 29 19b 7i 7ii 11 15
                  33 119alef 13 14 20 21
                  36 47 119beth 17i 17ii 27i 27ii
                  57 48 119gimel 25i 25ii 30 32
                  51 119dalet 26 28 41 46
                  119kof 117 119he 34i 34ii
                  
                  119nun 16 118 150 23 76i 76ii 115
                  42 19a 119vau 40i 40ii 45i 45ii
                  43 65 119zajin 53 54 49i 49ii
                  77 97 119chet 55i 55ii 62
                  80 81 119tet 56 57 72i 72ii
                  147 119jod 59 60 116 121
                  92 8 119kaf 61 64
                  
                  113 116ii 93 148 111
                  84 96 119lamed 71i 71ii 123 124
                  85 119mem 74i 74ii 125 131
                  86 98 70 75 126 127
                  87 99 119samech 79 132i 132ii
                  22i 22ii 22iii 135i 135ii
                  119ajin
                  
                  122 130 112
                  90 119pe 82 120 136i 136ii
                  101 144 119sade 88i 88ii 137 138
                  )

commonoptions = '--lettrine --dashes --no-paragraph' # sazba do sloupcu
# commonoptions = ''
# commonoptions = '--novydvur-newlines'

cislazalmu_zaltar.each do |z|
  zalmyzaltare << genzalm("zalm"+z+".zalm", commonoptions, adresar_zaltar)
end

canticleoptions = commonoptions+" --pretitle \"kantikum\\\\\\\\ \""

zalmyzaltare << genzalm('kantikum_fp2.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_ef1.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_zj4.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_kol1.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_zj11.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_zj15.zalm', canticleoptions, adresar_zaltar)

zalmyzaltare << genzalm('kantikum_dan3i.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_1kron29.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_tob13.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_jdt16.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_jer31.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz45.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_ex15.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_dan3ii.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_sir36.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz38.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_1sam2.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz12.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_hab3.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_dt32.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz2.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz26.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz33.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz40.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_jer14.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_mdr9.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_iz42.zalm', canticleoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_dan3iii.zalm', canticleoptions, adresar_zaltar)

zalmyzaltare << genzalm('kantikum_benedictus.zalm', commonoptions, adresar_zaltar)
zalmyzaltare << genzalm('kantikum_magnificat.zalm', commonoptions, adresar_zaltar)
# zalmyzaltare << genzalm('kantikum_zj19.zalm', '--no-formatting '+canticleoptions)


file "antifonar_zaltar.pdf" => ['antifonar_zaltar.tex', 'kantikum_zj19.tex', 'spolecne.tex']+zalmyzaltare do
  2.times { 
    # sh "cslatex antifonar_zaltar" 
    sh "pdflatex antifonar_zaltar"
  }
  # sh "dvipdf antifonar_zaltar.dvi"
end

task :zaltar => ["antifonar_zaltar.pdf"]

task :zaltar_clean => [:zaltar_texclean] do
  sh 'rm generovane/zaltar/zalm*.tex'
  sh 'rm generovane/zaltar/kantikum*.tex'
end

task :zaltar_texclean do
  (['pdf', 'aux', 'log', 'out'].map {|e| "antifonar_zaltar."+e}).each {|f|
    if File.exists? f then
      sh "rm #{f}"
    end
  }
end

###############
# uvod

file 'uvod_priklady_1.ly' => ['uvod_priklady.ly'] do
  chdir 'generovane'
  sh "#{RUBY_COMMAND} ../../nastroje/splitscores.rb --prepend-text '\\include \"spolecne_antifonar.ly\"' ../uvod_priklady.ly"
  chdir '..'
end

file 'vystup/antifonar_uvod.tex' => ['antifonar_uvod.lytex', 'uvod_priklady_1.ly'] do
  test_lilypondbook_version
  sh 'lilypond-book --pdf --output=vystup antifonar_uvod.lytex'
end

file 'vystup/antifonar_uvod.pdf' => ['vystup/antifonar_uvod.tex'] do
  chdir 'vystup'
  sh 'pdflatex antifonar_uvod.tex'
  chdir '..'
end

task :uvod => ['vystup/antifonar_uvod.pdf']

###############
# material k responsorialnimu prednesu zalmu 136

file "generovane/zalm136responsorialni.tex" => ["zalmy/zalm136responsorialni.zalm"] do
  chdir "generovane"
  sh "ruby ../../nastroje/psalmpreprocessor.rb --no-formatting ../zalmy/zalm136responsorialni.zalm"
  chdir ".."
end

file "vystup/zalm136.tex" => ["generovane/zalm136responsorialni.tex", "zalm136noty.ly", "spolecne.tex"] do
  sh "lilypond-book --out=vystup --pdf zalm136.lytex"
end

file "vystup/zalm136.pdf" => ["vystup/zalm136.tex"] do
  cd "vystup"
  sh "pdflatex zalm136"
  cd ".."
end

task :zalm136 => ["vystup/zalm136.pdf"]