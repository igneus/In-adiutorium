##############
# Antifonar: kompletar

def genzalm(zalm, options="")
  syrovy = "zalmy/"+zalm
  peceny = "generovane/"+zalm.gsub(/\.zalm/, '')+'.tex'
  preprocessor = "../nastroje/psalmpreprocessor.rb"
  file peceny => [syrovy, preprocessor] do
    chdir "generovane"
    sh "ruby ../#{preprocessor} #{options} ../#{syrovy}"
    chdir ".."
  end
  return peceny
end

file "vystup/antifonar_kompletar.pdf" => ["vystup/antifonar_kompletar.tex"] do
  chdir "vystup"
  sh "pdflatex antifonar_kompletar"
  chdir ".."
end

cislazalmu = [4, 134, 91, 86, 143, 31, 130, 16, 88]

zalmy_syrove = cislazalmu.map {|i| "zalm"+i.to_s+".zalm"}
zalmy_pecene = cislazalmu.map {|i| "generovane/zalm"+i.to_s+".tex"}

zalmy_syrove.each_index do |i|
  genzalm zalmy_syrove[i], "--last-accent-only --linebreak-at-the-end"
end

genzalm "kantikum_nuncdimittis.zalm", "--linebreak-at-the-end"

# doxologie s jednim akcentem na polovers
genzalm "doxologie.zalm", "--last-accent-only --no-title"
# doxologie se dvema akcenty na polovers
file "generovane/doxologie_2akcenty.tex" => ['zalmy/doxologie.zalm'] do
  chdir "generovane"
  sh "ruby ../../nastroje/psalmpreprocessor.rb --no-title --output doxologie_2akcenty.tex ../zalmy/doxologie.zalm"
  chdir ".."
end
  
file "vystup/antifonar_kompletar.tex" => ["antifonar_kompletar.lytex", "kompletar_1.ly", "generovane/doxologie.tex", "generovane/doxologie_2akcenty.tex", "generovane/kantikum_nuncdimittis.tex"]+zalmy_pecene do
  sh "lilypond-book --out=vystup --pdf antifonar_kompletar.lytex"
end

file "kompletar_1.ly" => ["../kompletar.ly"] do
  sh "ruby ../nastroje/splitscores.rb ../kompletar.ly"
end

task :default => ["vystup/antifonar_kompletar.pdf"]

###############
# material k responsorialnimu prednesu zalmu 136

file "generovane/zalm136responsorialni.tex" => ["zalmy/zalm136responsorialni.zalm"] do
  chdir "generovane"
  sh "ruby ../../nastroje/psalmpreprocessor.rb --no-formatting ../zalmy/zalm136responsorialni.zalm"
  chdir ".."
end

file "vystup/zalm136.tex" => ["generovane/zalm136responsorialni.tex", "zalm136noty.ly", "spolecne.tex"] do
  sh "lilypond-book --out=vystup --pdf zalm136.lytex"
end

file "vystup/zalm136.pdf" => ["vystup/zalm136.tex"] do
  cd "vystup"
  sh "pdflatex zalm136"
  cd ".."
end

#######################
# zaltar

zalmyzaltare = []

cislazalmu = [141, 142, 
                  63, 149]

zalmy_syrove = cislazalmu.map {|i| "zalm"+i.to_s+".zalm"}
zalmy_pecene = cislazalmu.map {|i| "generovane/zalm"+i.to_s+".tex"}

zalmy_syrove.each_index do |i|
  zalmyzaltare << genzalm(zalmy_syrove[i])
end

zalmyzaltare << genzalm('kantikum_fp2.zalm')
zalmyzaltare << genzalm('kantikum_dan3i.zalm')

file "antifonar_zaltar.pdf" => ['antifonar_zaltar.tex']+zalmyzaltare do
  sh "pdflatex antifonar_zaltar"
end

task :zaltar => ["antifonar_zaltar.pdf"]